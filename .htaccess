RewriteEngine On
RewriteBase /SH/


# production only
#RewriteCond %{HTTP_HOST} !^www\. [NC]
#RewriteCond %{HTTP_HOST} !^$ 
#RewriteRule ^ %{REQUEST_SCHEME}://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]



# --- Expires & Cache-Control
<IfModule mod_expires.c>
  ExpiresActive On

  # Par défaut (sécurité)
  ExpiresDefault "access plus 1 hour"

  # HTML/JSON : pas de cache agressif
  ExpiresByType text/html "access plus 0 seconds"
  ExpiresByType application/json "access plus 0 seconds"

  # Assets versionnés (hash ou numéro de version dans le nom)
  # ex: app.3.4.17.js, app.abc123.css, styles.20251021.css
  <FilesMatch "\.(?:css|js)$">
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
  </FilesMatch>

  # Images
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Fonts
  ExpiresByType font/ttf   "access plus 1 year"
  ExpiresByType font/otf   "access plus 1 year"
  ExpiresByType font/woff  "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"

  # Autres binaires statiques
  ExpiresByType application/pdf  "access plus 1 year"
  ExpiresByType application/zip  "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
  # Empêche un cache agressif sur HTML/JSON
  <FilesMatch "\.(?:html?|json)$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
  </FilesMatch>

  # Par défaut sur les assets : 1 an + public
  <FilesMatch "\.(?:css|js|png|jpe?g|gif|webp|avif|svg|ico|woff2?|ttf|otf|pdf|zip)$">
    Header set Cache-Control "public, max-age=31536000"
  </FilesMatch>

  # **Immutable** pour les fichiers clairement versionnés (hash ou numéro de version)
  # - hash : styles.3f2a9c1.css / app.a1b2c3.js
  <FilesMatch "\.[0-9a-f]{6,}\.(?:css|js)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  # - semver : app.1.2.3.js / lib-20251021.css
  <FilesMatch "\.(?:\d{6,}|\d+\.\d+\.\d+)\.(?:css|js)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Toujours varier sur la compression
  Header append Vary "Accept-Encoding" env=!dont-vary
</IfModule>

# (Optionnel) Désactiver ETag pour éviter les collisions multi-serveurs
FileETag None
<IfModule mod_headers.c>
  Header unset ETag
</IfModule>

# 0) Homepage du dossier SH → pager.php
RewriteRule ^$ pager.php [QSA,L]

# 1) Laisser passer les fichiers / dossiers réels
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# 2) Tout le reste va vers pager.php
#   - REQUEST_URI reste dispo en PHP
#   - On passe aussi la partie chemin dans ?path=
RewriteRule ^(.*)$ pager.php?path=$1 [QSA,L]