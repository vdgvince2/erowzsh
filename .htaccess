RewriteEngine On
RewriteBase /SH/


# production only
#RewriteCond %{HTTP_HOST} !^www\. [NC]
#RewriteCond %{HTTP_HOST} !^$ 
#RewriteRule ^ %{REQUEST_SCHEME}://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Ne pas réécrire 
RewriteRule ^scripts/ - [L]
RewriteRule ^monitoring/ - [L]

# --- Expires & Cache-Control
<IfModule mod_expires.c>
  ExpiresActive On

  # Par défaut (sécurité)
  ExpiresDefault "access plus 1 hour"

  # HTML/JSON : pas de cache agressif
  ExpiresByType text/html "access plus 0 seconds"
  ExpiresByType application/json "access plus 0 seconds"

  # Assets versionnés (hash ou numéro de version dans le nom)
  # ex: app.3.4.17.js, app.abc123.css, styles.20251021.css
  <FilesMatch "\.(?:css|js)$">
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
  </FilesMatch>

  # Images
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Fonts
  ExpiresByType font/ttf   "access plus 1 year"
  ExpiresByType font/otf   "access plus 1 year"
  ExpiresByType font/woff  "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"

  # Autres binaires statiques
  ExpiresByType application/pdf  "access plus 1 year"
  ExpiresByType application/zip  "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
  # Empêche un cache agressif sur HTML/JSON
  <FilesMatch "\.(?:html?|json)$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
  </FilesMatch>

  # Par défaut sur les assets : 1 an + public
  <FilesMatch "\.(?:css|js|png|jpe?g|gif|webp|avif|svg|ico|woff2?|ttf|otf|pdf|zip)$">
    Header set Cache-Control "public, max-age=31536000"
  </FilesMatch>

  # **Immutable** pour les fichiers clairement versionnés (hash ou numéro de version)
  # - hash : styles.3f2a9c1.css / app.a1b2c3.js
  <FilesMatch "\.[0-9a-f]{6,}\.(?:css|js)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  # - semver : app.1.2.3.js / lib-20251021.css
  <FilesMatch "\.(?:\d{6,}|\d+\.\d+\.\d+)\.(?:css|js)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Toujours varier sur la compression
  Header append Vary "Accept-Encoding" env=!dont-vary
</IfModule>

# (Optionnel) Désactiver ETag pour éviter les collisions multi-serveurs
FileETag None
<IfModule mod_headers.c>
  Header unset ETag
</IfModule>


# 1) Homepage (doit être AVANT le garde -f/-d)
RewriteRule ^$ homepage.php [END,QSA]

# Rediriger tout le dossier /r/Details/ vers la homepage (specifique Irelande)
RewriteRule ^r/Details/.*$ / [R=301,L]

# 2) Pages statiques (hardcodées)
RewriteRule ^s/cookies/?$                 page.php?slug=cookies                 [END,QSA,NC]
RewriteRule ^s/help/?$                    page.php?slug=help                    [END,QSA,NC]
RewriteRule ^s/contact/?$                 contact.php                           [END,QSA,NC]
RewriteRule ^s/cart/?$                    cart.php                              [END,QSA,NC]
RewriteRule ^s/privacy/?$                 page.php?slug=privacy                 [END,QSA,NC]
RewriteRule ^s/press/?$                   page.php?slug=press                   [END,QSA,NC]
RewriteRule ^s/about/?$                   page.php?slug=about                   [END,QSA,NC]
RewriteRule ^s/home/categoriesindex/?$    page.php?slug=home/categoriesindex    [END,QSA,NC]

RewriteRule ^s/registration/?$            page.php?slug=registration            [END,QSA,NC]
RewriteRule ^s/money-back/?$              page.php?slug=money-back-guarantee    [END,QSA,NC]
RewriteRule ^s/money-back-guarantee/?$    page.php?slug=money-back-guarantee    [END,QSA,NC]
RewriteRule ^s/bidding-and-buying-help/?$ page.php?slug=bidding-and-buying-help [END,QSA,NC]
RewriteRule ^s/stores/?$                  page.php?slug=stores                  [END,QSA,NC]
RewriteRule ^s/start-selling/?$           page.php?slug=start-selling           [END,QSA,NC]
RewriteRule ^s/learn-to-sell/?$           page.php?slug=learn-to-sell           [END,QSA,NC]
RewriteRule ^s/business-sellers/?$        page.php?slug=business-sellers        [END,QSA,NC]
RewriteRule ^s/seller-centre/?$           page.php?slug=seller-centre           [END,QSA,NC]
RewriteRule ^s/developers/?$              page.php?slug=developers              [END,QSA,NC]
RewriteRule ^s/security-centre/?$         page.php?slug=security-centre         [END,QSA,NC]
RewriteRule ^s/site-map/?$                page.php?slug=site-map                [END,QSA,NC]
RewriteRule ^s/official-time/?$           page.php?slug=official-time           [END,QSA,NC]
RewriteRule ^s/myaccount/?$               page.php?slug=myaccount               [END,QSA,NC]
RewriteRule ^s/watchlist/?$               page.php?slug=watchlist               [END,QSA,NC]

# 3) Catégories (1 à 3 niveaux)
RewriteRule ^s/([^/]+)/?$                             template.php?categ=1&level1=$1                      [END,QSA]
RewriteRule ^s/([^/]+)/([^/]+)/?$                     template.php?categ=1&level1=$1&level2=$2            [END,QSA]
RewriteRule ^s/([^/]+)/([^/]+)/([^/]+)/?$             template.php?categ=1&level1=$1&level2=$2&level3=$3  [END,QSA]

# 4) Mots-clés
RewriteRule ^([a-z0-9\-]+)/?$                         template.php?keyword=$1                              [END,QSA]

# 5) Laisser passer les fichiers/dossiers réels (après nos réécritures virtuelles)
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# 6) Fallback global : tout le reste → 404/redirect map gérée dans fallback.php
RewriteRule ^.+$ fallback.php [L,QSA]